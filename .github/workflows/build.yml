name: Build

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release with artifacts'
        required: false
        type: boolean
        default: true
  push:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  RCLONE_VERSION: '1.68.2'

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            rclone_os: linux
            rclone_arch: amd64
            rclone_ext: ''
            sidecar_suffix: '-x86_64-unknown-linux-gnu'
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            rclone_os: windows
            rclone_arch: amd64
            rclone_ext: '.exe'
            sidecar_suffix: '-x86_64-pc-windows-msvc.exe'
          - platform: macos-latest
            target: aarch64-apple-darwin
            rclone_os: osx
            rclone_arch: arm64
            rclone_ext: ''
            sidecar_suffix: '-aarch64-apple-darwin'
          - platform: macos-latest
            target: x86_64-apple-darwin
            rclone_os: osx
            rclone_arch: amd64
            rclone_ext: ''
            sidecar_suffix: '-x86_64-apple-darwin'

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      # --- System dependencies (Linux) ---
      - name: Install system dependencies (Ubuntu)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      # --- Node.js ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # --- Rust ---
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      # --- rclone sidecar ---
      - name: Download rclone sidecar (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p src-tauri/sidecars
          curl -fsSL "https://downloads.rclone.org/v${{ env.RCLONE_VERSION }}/rclone-v${{ env.RCLONE_VERSION }}-${{ matrix.rclone_os }}-${{ matrix.rclone_arch }}.zip" -o rclone.zip
          unzip -o rclone.zip
          cp "rclone-v${{ env.RCLONE_VERSION }}-${{ matrix.rclone_os }}-${{ matrix.rclone_arch }}/rclone" \
             "src-tauri/sidecars/rclone${{ matrix.sidecar_suffix }}"
          chmod +x "src-tauri/sidecars/rclone${{ matrix.sidecar_suffix }}"
          rm -rf rclone.zip rclone-v*

      - name: Download rclone sidecar (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path src-tauri\sidecars | Out-Null
          Invoke-WebRequest -Uri "https://downloads.rclone.org/v${{ env.RCLONE_VERSION }}/rclone-v${{ env.RCLONE_VERSION }}-windows-amd64.zip" -OutFile rclone.zip
          Expand-Archive -Path rclone.zip -DestinationPath . -Force
          Copy-Item "rclone-v${{ env.RCLONE_VERSION }}-windows-amd64\rclone.exe" "src-tauri\sidecars\rclone${{ matrix.sidecar_suffix }}"
          Remove-Item rclone.zip, "rclone-v*" -Recurse -Force

      # --- Generate icons if missing ---
      - name: Generate placeholder icons (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd src-tauri/icons
          python3 -c "
          import struct, zlib, shutil
          def png(w,h):
              def chunk(t,d):return struct.pack('>I',len(d))+t+d+struct.pack('>I',zlib.crc32(t+d)&0xffffffff)
              raw=b''
              for y in range(h):
                  raw+=b'\x00'
                  for x in range(w):
                      raw+=b'\x19\x76\xd2\xff'
              return b'\x89PNG\r\n\x1a\n'+chunk(b'IHDR',struct.pack('>IIBBBBB',w,h,8,6,0,0,0))+chunk(b'IDAT',zlib.compress(raw))+chunk(b'IEND',b'')
          def ico(sizes):
              images=[]
              for s in sizes:
                  d=png(s,s)
                  images.append((s,d))
              n=len(images)
              hdr=struct.pack('<HHH',0,1,n)
              offset=6+n*16
              entries=b''
              data=b''
              for s,d in images:
                  w=s if s<256 else 0
                  entries+=struct.pack('<BBBBHHII',w,w,0,0,1,32,len(d),offset)
                  data+=d
                  offset+=len(d)
              return hdr+entries+data
          for s in [32,128,256]:
              p=png(s,s)
              with open(f'{s}x{s}.png','wb') as f: f.write(p)
          shutil.copy('256x256.png','128x128@2x.png')
          with open('icon.ico','wb') as f: f.write(ico([32,128,256]))
          shutil.copy('128x128.png','icon.icns')
          shutil.copy('32x32.png','tray-icon.png')
          print('Generated all placeholder icons')
          "

      - name: Generate placeholder icons (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd src-tauri/icons
          python -c @"
          import struct, zlib, shutil
          def png(w,h):
              def chunk(t,d):return struct.pack('>I',len(d))+t+d+struct.pack('>I',zlib.crc32(t+d)&0xffffffff)
              raw=b''
              for y in range(h):
                  raw+=b'\x00'
                  for x in range(w):
                      raw+=b'\x19\x76\xd2\xff'
              return b'\x89PNG\r\n\x1a\n'+chunk(b'IHDR',struct.pack('>IIBBBBB',w,h,8,6,0,0,0))+chunk(b'IDAT',zlib.compress(raw))+chunk(b'IEND',b'')
          def ico(sizes):
              images=[]
              for s in sizes:
                  d=png(s,s)
                  images.append((s,d))
              n=len(images)
              hdr=struct.pack('<HHH',0,1,n)
              offset=6+n*16
              entries=b''
              data=b''
              for s,d in images:
                  w=s if s<256 else 0
                  entries+=struct.pack('<BBBBHHII',w,w,0,0,1,32,len(d),offset)
                  data+=d
                  offset+=len(d)
              return hdr+entries+data
          for s in [32,128,256]:
              p=png(s,s)
              with open(f'{s}x{s}.png','wb') as f: f.write(p)
          shutil.copy('256x256.png','128x128@2x.png')
          with open('icon.ico','wb') as f: f.write(ico([32,128,256]))
          shutil.copy('128x128.png','icon.icns')
          shutil.copy('32x32.png','tray-icon.png')
          print('Generated all placeholder icons')
          "@

      # --- Pre-download AppImage tools with retry (GitHub CDN can be flaky) ---
      - name: Pre-download linuxdeploy tools
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          TOOLS_DIR="src-tauri/target/${{ matrix.target }}/release/bundle/appimage"
          mkdir -p "$TOOLS_DIR"
          for tool in \
            "https://github.com/tauri-apps/binary-releases/releases/download/apprun-old/AppRun-x86_64" \
            "https://github.com/tauri-apps/binary-releases/releases/download/linuxdeploy/linuxdeploy-x86_64.AppImage"; do
            FILENAME=$(basename "$tool")
            echo "Downloading $FILENAME..."
            for attempt in 1 2 3 4 5; do
              if curl -fsSL --retry 3 --retry-delay 5 -o "$TOOLS_DIR/$FILENAME" "$tool"; then
                echo "  ✓ Downloaded $FILENAME (attempt $attempt)"
                chmod +x "$TOOLS_DIR/$FILENAME"
                break
              fi
              echo "  ✗ Attempt $attempt failed, waiting 15s..."
              sleep 15
            done
          done
          ls -la "$TOOLS_DIR/"

      # --- Install frontend deps ---
      - name: Install frontend dependencies
        run: npm install

      # --- Build with Tauri ---
      - uses: tauri-apps/tauri-action@v0
        id: tauri
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --target ${{ matrix.target }}
          tagName: v__VERSION__
          releaseName: 'ReadyNextOs Drive v__VERSION__'
          releaseBody: |
            ## ReadyNextOs Drive v__VERSION__

            Klient synchronizacji plików dla ReadyNextOs.

            ### Instalacja
            - **Windows**: Pobierz `.msi` i uruchom instalator
            - **macOS**: Pobierz `.dmg`, otwórz i przeciągnij do Aplikacji
            - **Linux (Debian/Ubuntu)**: Pobierz `.deb` i zainstaluj: `sudo dpkg -i *.deb`
            - **Linux (uniwersalny)**: Pobierz `.AppImage`, nadaj uprawnienia `chmod +x` i uruchom
          releaseDraft: true
          prerelease: true
          includeRelease: ${{ github.event.inputs.create_release == 'true' || github.event_name == 'push' }}

      # --- Upload individual artifacts ---
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: drive-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.rpm
          retention-days: 30
          if-no-files-found: warn
